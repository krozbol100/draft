{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "connString": {"type": "secureObject"},
      "utcValue": {"type": "string", "defaultValue": "[utcNow()]"}
    },
    "variables": {
        "pass": "[concat('''',parameters('connString').sqlPassword,'''')]"
    },
    "resources": [
      {
        "type": "Microsoft.Resources/deploymentScripts",
        "apiVersion": "2020-10-01",
        "name": "runPowerShellInlineWithOutput",
        "location": "[resourceGroup().location]",
        "kind": "AzurePowerShell",
        "properties": {
          "forceUpdateTag": "[parameters('utcValue')]",
          "azPowerShellVersion": "5.0",
          "scriptContent": "
            $sqlServerName = $args[0]
            $sqlAdmin = $args[1]
            $sqlPassword = $args[2]
            $databaseName = $args[3]
            $connStr = 'Server=tcp:' + $sqlServerName + ',1433;Initial Catalog=' + $databaseName + ';Persist Security Info=False;User ID=' + $sqlAdmin + ';Password=' + $sqlPassword + ';MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;'

            $key = [Byte[]](122, 2, 87, 224, 212, 156, 97, 98, 4, 1, 78, 92, 44, 43, 201, 14)
            $IV = [Byte[]](73, 37, 17, 71, 1, 31, 33, 77)

            $r = New-Object System.Security.Cryptography.RC2CryptoServiceProvider
            $r.Key = $key
            $r.IV = $IV
            $ms = New-Object IO.MemoryStream
            $c = $r.CreateEncryptor()
            $cs = New-Object Security.Cryptography.CryptoStream $ms,$c,\"Write\"
            $sw = New-Object IO.StreamWriter $cs
            $sw.Write($connStr)

            $sw.Close()  
            $cs.Close() 
            $ms.Close() 
            $r.Clear() 

            [byte[]]$result = $ms.ToArray() 

            $resultString = [Convert]::ToBase64String($result);
            $DeploymentScriptOutputs['text'] = $resultString
            $DeploymentScriptOutputs['sql'] = $args[2]
        ",
          "arguments": "[concat(parameters('connString').sqlServerName,' ', parameters('connString').sqlAdmin, ' ''', parameters('connString').sqlPassword, ''' ',parameters('connString').databaseName)]",
          "timeout": "PT1H",
          "cleanupPreference": "OnSuccess",
          "retentionInterval": "P1D"
        }
      }
    ],
    "outputs": {
      "result": {
        "value": "[concat(reference('runPowerShellInlineWithOutput').outputs.sql,' i onda ', variables('pass'))]",
        "type": "string"
      }
    }
  }